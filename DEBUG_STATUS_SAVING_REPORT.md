# Отчет: Отладка Проблемы со Статусом "Done"

## Проблема
Статус "Done" не сохраняется, появляется ошибка "Failed to save task changes".

## Добавленное логирование

### 1. Расширенное логирование в `updateZoneObject`
**Файл:** `src/lib/supabase.ts`

**Добавлено:**
- Логирование типа данных статуса и приоритета
- Логирование данных перед отправкой в базу
- Подробная информация об ошибках (код, детали, подсказки)

### 2. Расширенное логирование в `handleTaskSave`
**Файл:** `src/components/HexGridSystem.tsx`

**Добавлено:**
- Логирование типа и значения приоритета
- Более подробная информация о передаваемых данных

### 3. Тестовая функция
**Файл:** `src/lib/supabase.ts`

**Добавлена функция:** `testUpdateZoneObject`
- Позволяет протестировать обновление с простыми данными
- Помогает определить, проблема в данных или в логике

## Инструкции для отладки

### Шаг 1: Проверьте консоль браузера
1. Откройте Developer Tools (F12)
2. Перейдите на вкладку Console
3. Попробуйте изменить статус на "Done"
4. Посмотрите на логи в консоли

### Шаг 2: Ожидаемые логи
При изменении статуса вы должны увидеть:
```
=== SAVING TASK CHANGES ===
Status: done
Status type: string
Priority: medium
Priority type: string
=== SAVING TO DATABASE ===
=== UPDATING ZONE OBJECT ===
Object ID: [uuid]
Updates to apply: {status: "done", priority: "medium", ...}
Status update: done
Status update type: string
Data to send to database: {status: "done", priority: "medium", updated_at: "..."}
```

### Шаг 3: Проверьте ошибки
Если есть ошибка, вы увидите:
```
Error updating zone object: [error object]
Error details: [подробности ошибки]
Error code: [код ошибки]
```

## Возможные причины проблемы

### 1. **Проблема с типом данных**
- Статус может передаваться как неправильный тип
- База данных может ожидать другой формат

### 2. **Проблема с ограничениями**
- В таблице могут быть ограничения, которые мы не видим
- Возможно, статус "done" не разрешен

### 3. **Проблема с RLS**
- Row Level Security может блокировать обновления
- Возможно, нужны дополнительные права

### 4. **Проблема с ID объекта**
- ObjectId может быть неправильным
- Объект может не существовать в базе

## Следующие шаги

### 1. Проверьте логи в консоли
- Какие значения передаются?
- Есть ли ошибки?
- Какой тип данных у статуса?

### 2. Проверьте базу данных
```sql
-- Проверьте, есть ли объекты в таблице
SELECT * FROM zone_objects LIMIT 5;

-- Проверьте ограничения для поля status
SELECT constraint_name, check_clause 
FROM information_schema.check_constraints 
WHERE constraint_name LIKE '%zone_objects%';
```

### 3. Проверьте RLS
```sql
-- Проверьте, включен ли RLS
SELECT schemaname, tablename, rowsecurity 
FROM pg_tables 
WHERE tablename = 'zone_objects';
```

## Файлы изменены:
- `src/lib/supabase.ts` - добавлено расширенное логирование и тестовая функция
- `src/components/HexGridSystem.tsx` - добавлено логирование типов данных

## Ожидаемый результат:
После добавления логирования мы сможем точно определить, где происходит ошибка и почему статус "Done" не сохраняется.
